<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Your iAscendAi Identity</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="app-shell">
    <div class="card card--narrow">

      <div class="brand-row">
        <div class="brand-mark">@</div>
        <div>
          <h1>iAscendAi</h1>
          <h2>Claim Your Verified Identity</h2>
        </div>
      </div>

      <h2>Create Username</h2>
      <p class="subtext">
        Link your recent SoulMarkⓈ-verified transaction to a permanent
        iAscendAi identity. One username per email — forever.
      </p>

      <p class="label">Email (locked from your donation)</p>
      <div id="lockedEmail" class="chip"></div>

      <p class="label">Latest SoulMarkⓈ</p>
      <div id="lockedSoulmark" class="value truncate"></div>

      <label class="label" style="margin-top:14px;">Choose Username *</label>
      <div style="display:flex; align-items:center; gap:6px;">
        <input id="username" type="text" placeholder="yourname"
               style="flex:1;" autocomplete="off" />
        <div style="font-size:0.9rem; opacity:0.8;">@iascendai</div>
      </div>
      <p id="usernameStatus" class="small-label"></p>

      <button id="registerBtn" class="btn-primary">
        Create My iAscendAi Identity
      </button>

      <p id="registerStatus" class="small-label" style="margin-top:10px;"></p>

    </div>
  </div>

  <script>
    const BACKEND_URL = "https://fundtrackerai.onrender.com";

    const emailEl = document.getElementById("lockedEmail");
    const smEl = document.getElementById("lockedSoulmark");
    const usernameInput = document.getElementById("username");
    const usernameStatus = document.getElementById("usernameStatus");
    const registerStatus = document.getElementById("registerStatus");

    let baseEmail = "";
    let latestSoulmark = "";
    let usernameTimer = null;
    let lastCheckName = "";

    // Load from localStorage
    (function preload() {
      try {
        baseEmail = localStorage.getItem("fta_email") || "";
        latestSoulmark = localStorage.getItem("fta_soulmark") || "";

        emailEl.textContent = baseEmail || "missing-email@example.com";

        smEl.textContent = latestSoulmark
          ? latestSoulmark.substring(0, 18) + "..."
          : "No SoulMark found. You may need to donate again.";
      } catch (e) {
        emailEl.textContent = "Unavailable";
      }
    })();

    // Username availability check (debounced)
    usernameInput.addEventListener("input", () => {
      const raw = usernameInput.value.trim();
      usernameStatus.textContent = "";
      registerStatus.textContent = "";

      if (!raw) return;

      const cleaned = raw.toLowerCase().replace(/[^a-z0-9._-]/g, "");
      if (cleaned !== raw.toLowerCase()) {
        usernameStatus.textContent = "Use letters, numbers, dots, dashes, or underscores.";
      }
      if (cleaned.length < 3) {
        usernameStatus.textContent = "Username must be at least 3 characters.";
        return;
      }

      if (usernameTimer) clearTimeout(usernameTimer);
      usernameTimer = setTimeout(() => {
        checkUsername(cleaned);
      }, 350);
    });

    async function checkUsername(name) {
      lastCheckName = name;
      usernameStatus.textContent = "Checking availability…";

      try {
        const res = await fetch(
          `${BACKEND_URL}/check-username/${encodeURIComponent(name)}`
        );
        const data = await res.json();

        if (name !== lastCheckName) return;

        usernameStatus.textContent = data.available
          ? "✅ Available"
          : "❌ Already taken";

      } catch (err) {
        console.error(err);
        usernameStatus.textContent = "Error checking username.";
      }
    }

    // Register identity
    document.getElementById("registerBtn").addEventListener("click", async () => {
      registerStatus.textContent = "";

      const unameRaw = usernameInput.value.trim().toLowerCase();
      const uname = unameRaw.replace(/[^a-z0-9._-]/g, "");
      if (!uname || uname.length < 3) {
        registerStatus.textContent = "Please enter a valid username (3+ characters).";
        return;
      }

      if (!baseEmail || !latestSoulmark) {
        registerStatus.textContent = "Missing email or SoulMark. Try completing a donation first.";
        return;
      }

      registerStatus.textContent = "Creating your identity…";

      try {
        const res = await fetch(`${BACKEND_URL}/register-username`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: baseEmail,
            username: uname,
            soulmark: latestSoulmark
          })
        });

        const data = await res.json();

        if (!data.success) {
          registerStatus.textContent = data.message || "Unable to create identity.";
          return;
        }

        // Save identity locally
        try {
          localStorage.setItem("ias_username", data.identity.username || uname);
          localStorage.setItem("ias_email", data.identity.email || baseEmail);
          localStorage.setItem("ias_soulmark", data.identity.soulmark || latestSoulmark);
          localStorage.setItem("ias_identity_id", data.identity.identity_id || "");
        } catch (e) {}

        registerStatus.textContent = "Identity created. Redirecting to dashboard…";

        setTimeout(() => {
          window.location.href = "iascendai-dashboard.html";
        }, 600);

      } catch (err) {
        console.error(err);
        registerStatus.textContent = "Network error creating identity.";
      }
    });
  </script>
</body>
</html>
