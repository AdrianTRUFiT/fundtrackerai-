<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My SoulMarks‚ìà ‚Äî iAscendAi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="app-shell">
    <div class="card">

      <div class="brand-row">
        <div class="brand-mark">üîê</div>
        <div>
          <h1>My SoulMarks‚ìà</h1>
          <h2>Authored Identity Ledger</h2>
        </div>
      </div>

      <p class="subtext">
        These SoulMarks‚ìà are tied to the verified email on this device.
        Each entry represents a cryptographic proof of a real, recorded event.
      </p>

      <!-- SUMMARY -->
      <div class="dash-card">
        <div class="dash-title">SoulMark‚ìà Summary</div>
        <p class="small-label">Total SoulMarks‚ìà</p>
        <div id="smTotalCount" class="value">0</div>

        <p class="small-label" style="margin-top:10px;">Total Verified Amount</p>
        <div id="smTotalAmount" class="value">$0.00</div>
      </div>

      <!-- LIST -->
      <div class="dash-card">
        <div class="dash-title">SoulMark‚ìà Records</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>SoulMark‚ìà</th>
                <th>Amount</th>
                <th>When</th>
              </tr>
            </thead>
            <tbody id="smRows">
              <tr><td colspan="3">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <p class="small-label" style="margin-top:8px;">
          Tap a SoulMark‚ìà row to copy the full value for verification or support.
        </p>
      </div>

      <button class="btn-secondary" onclick="goBack()">
        Back to iAscendAi Dashboard
      </button>

    </div>
  </div>

  <script>
    const BACKEND_URL = "https://fundtrackerai.onrender.com";

    function maskSoulmark(sm) {
      if (!sm) return "N/A";
      if (sm.length <= 16) return sm;
      return sm.substring(0, 10) + "‚Ä¶" + sm.substring(sm.length - 6);
    }

    async function loadSoulmarks() {
      const tbody = document.getElementById("smRows");
      const totalCountEl = document.getElementById("smTotalCount");
      const totalAmountEl = document.getElementById("smTotalAmount");

      const identityEmail =
        localStorage.getItem("ias_email") ||
        localStorage.getItem("fta_email") ||
        "";

      if (!identityEmail) {
        tbody.innerHTML =
          "<tr><td colspan='3'>No identity email found on this device.</td></tr>";
        return;
      }

      try {
        const res = await fetch(`${BACKEND_URL}/donations`);
        const data = await res.json();
        const donations = data.donations || [];

        // Filter to this user
        const mine = donations.filter(
          d => d.email &&
               d.email.toLowerCase() === identityEmail.toLowerCase()
        );

        if (!mine.length) {
          tbody.innerHTML =
            "<tr><td colspan='3'>No SoulMarks‚ìà found for this identity.</td></tr>";
          totalCountEl.textContent = "0";
          totalAmountEl.textContent = "$0.00";
          return;
        }

        const totalAmount = mine.reduce((sum, d) => sum + (d.amount || 0), 0);
        totalAmountEl.textContent = "$" + (totalAmount / 100).toFixed(2);
        totalCountEl.textContent = String(mine.length);

        const rowsHtml = mine
          .slice()
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
          .map(d => {
            const full = d.soulmark || "";
            const short = maskSoulmark(full);
            const amt = "$" + ((d.amount || 0) / 100).toFixed(2);
            const when = d.timestamp
              ? new Date(d.timestamp).toLocaleString()
              : "N/A";

            const escFull = full.replace(/"/g, "&quot;");

            return `<tr class="clickable-row" data-full="${escFull}">
              <td class="truncate" title="${escFull}">${short}</td>
              <td>${amt}</td>
              <td>${when}</td>
            </tr>`;
          })
          .join("");

        tbody.innerHTML = rowsHtml;

        // Attach copy handlers
        document.querySelectorAll(".clickable-row").forEach(row => {
          row.addEventListener("click", () => {
            const sm = row.getAttribute("data-full");
            if (!sm) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(sm).then(() => {
                row.classList.add("copied");
                setTimeout(() => row.classList.remove("copied"), 400);
              }).catch(() => {
                alert("Full SoulMark‚ìà: " + sm);
              });
            } else {
              alert("Full SoulMark‚ìà: " + sm);
            }
          });
        });

      } catch (err) {
        console.error(err);
        tbody.innerHTML =
          "<tr><td colspan='3'>Error loading SoulMarks‚ìà.</td></tr>";
      }
    }

    function goBack() {
      window.location.href = "iascendai-dashboard.html";
    }

    loadSoulmarks();
  </script>
</body>
</html>